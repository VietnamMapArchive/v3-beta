<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>VMA Map Viewer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.5.2/ol.css">
  <script src="https://cdn.jsdelivr.net/npm/ol@v7.5.2/dist/ol.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@allmaps/openlayers/dist/bundled/allmaps-openlayers-8.umd.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom OpenLayers Control Positioning */
    .ol-zoom { top: 1rem !important; right: 1rem !important; left: auto !important; }
    .ol-rotate { top: calc(1rem + 50px) !important; right: 1rem !important; left: auto !important; }
    .ol-scale-line { background: rgba(255,255,255,0.7); padding: 2px 6px; border-radius: 6px; }

    /* Custom scrollbar for panels */
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }

    /* Sidebar collapse styles */
    #sidebar.collapsed {
      width: 64px; /* Tailwind w-16 */
    }
    #sidebar.collapsed .collapsible-content {
      display: none;
    }
    #sidebar.collapsed header .flex {
      justify-content: center;
    }
    #sidebar.collapsed #collapsed-nav {
      display: flex;
    }

    /* For Spyglass/Side-by-Side Dividers and Handles */
    .divider-v { position:absolute; top:0; left:0; width:0; height:0; border-left:2px dashed rgba(0,0,0,0.45); pointer-events:none; z-index:999; display:none; }
    .divider-h { position:absolute; top:0; left:0; width:0; height:0; border-top:2px dashed rgba(0,0,0,0.45); pointer-events:none; z-index:999; display:none; }
    .lens { position: absolute; pointer-events: none; border: 2px solid rgba(0,0,0,0.5); border-radius: 9999px; box-shadow: 0 0 0 2px rgba(255,255,255,0.85) inset; z-index: 999; display: none; cursor: default; }
    .handle, .lens-handle {
      position: absolute; width: 16px; height: 16px; border-radius: 9999px;
      background: #fff; border: 2px solid rgba(0,0,0,0.55); box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      z-index: 1000; display: none; pointer-events: auto;
    }
    .handle-v { cursor: ew-resize; }
    .handle-h { cursor: ns-resize; }
    .lens-handle { cursor: nwse-resize; }
    
    /* Active tab state styles */
    .tab-btn-desktop.active {
      background-color: #e5e7eb; /* gray-200 */
      color: #1f2937; /* gray-800 */
      border-bottom: 2px solid #4f46e5; /* indigo-600 */
    }
    
    .tool-btn.active {
      background-color: #1f2937; /* gray-800 */
      color: #ffffff;
      border-color: #1f2937;
    }
    .seg-btn.active {
      background-color: #1f2937; /* gray-800 */
      color: #ffffff;
      border-color: #1f2937;
    }
    .anno-label[readonly] {
      cursor: pointer;
    }
    .view-mode-btn.active {
      background-color: #eef2ff; /* indigo-100 */
      border-color: #4f46e5; /* indigo-600 */
      color: #4f46e5;
      font-weight: 600;
    }
    
    /* For Popup Arrow */
    #popup:before {
      content: "";
      position: absolute;
      top: 100%;
      left: 48px;
      border-width: 8px;
      border-style: solid;
      border-color: #d1d5db transparent transparent transparent;
    }

    /* Guided Tour styles */
    .tour-backdrop { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.55); z-index: 1100; display: none; }
    .tour-highlight { position: fixed; border-radius: 10px; box-shadow: 0 0 0 3px #6366f1, 0 10px 30px rgba(0,0,0,0.4); z-index: 1102; display: none; background: transparent; pointer-events: none; }
    .tour-popover {
      position: fixed; z-index: 1103; display: none; max-width: 340px;
      background: #fff; color: #111827; border: 1px solid #e5e7eb; border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }
    .tour-popover .tour-header { padding: 10px 12px; border-bottom: 1px solid #e5e7eb; font-weight: 700; }
    .tour-popover .tour-body { padding: 10px 12px; font-size: 0.9rem; }
    .tour-popover .tour-footer { padding: 10px 12px; display: flex; align-items: center; justify-content: space-between; gap: 8px; border-top: 1px solid #e5e7eb; }
    .tour-popover .btn { padding: 6px 10px; font-weight: 600; border-radius: 8px; border: 1px solid #e5e7eb; }
    .tour-popover .btn-primary { background: #4f46e5; border-color: #4f46e5; color: #fff; }
    .tour-popover .btn-ghost { background: #fff; color: #374151; }
    .tour-popover .counter { font-size: 12px; color: #6b7280; }
  </style>
</head>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-D24YYC6FYG"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-D24YYC6FYG');
</script>
<body class="bg-gray-800 font-sans antialiased overflow-hidden">

  <!-- Main container -->
  <div class="h-screen w-screen flex">
    <!-- Sidebar -->
    <aside id="sidebar" class="relative z-20 h-full flex flex-col w-full md:w-96 bg-gray-50 border-r border-gray-200 shadow-lg transition-all duration-300 ease-in-out">
      <!-- Sidebar header -->
      <header class="flex items-center justify-between gap-3 p-4 border-b border-gray-200 bg-white">
        <div class="flex items-center gap-3 overflow-hidden">
          <img src="https://raw.githubusercontent.com/lqtue/VMA/main/data/logo.png" alt="Logo" class="w-8 h-8 flex-shrink-0">
          <div class="collapsible-content">
            <h1 class="text-lg font-bold text-gray-800">Vietnam Map Archive project</h1>
            <p class="text-xs text-gray-500">Map Viewer</p>
          </div>
        </div>
        <div class="collapsible-content md:hidden">
          <button id="hamburger-menu" class="p-2 rounded-md hover:bg-gray-200">
            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
          </button>
        </div>
      </header>

      <!-- Collapsed sidebar navigation -->
      <div id="collapsed-nav" class="hidden h-full flex-col items-center pt-5 space-y-4 bg-white border-r">
        <button data-tab="Map" class="collapsed-tab-btn p-3 rounded-lg hover:bg-gray-200" title="Map">
          <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13v-6m0-6V4m6 16l-5.447-2.724A1 1 0 019 16.382V5.618a1 1 0 011.447-.894L15 7m0 13v-6m0-6V4"></path></svg>
        </button>
        <button data-tab="Annotations" class="collapsed-tab-btn p-3 rounded-lg hover:bg-gray-200" title="Annotations">
          <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
        </button>
        <button data-tab="Story" class="collapsed-tab-btn p-3 rounded-lg hover:bg-gray-200" title="Story">
          <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
        </button>
        <button data-tab="Info" class="collapsed-tab-btn p-3 rounded-lg hover:bg-gray-200" title="Info">
          <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 9a3 3 0 116 0c0 2-2 3-3 3h-1v1" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 17h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </button>
      </div>
      
      <!-- Sidebar navigation -->
      <nav class="flex border-b border-gray-200 bg-gray-100 collapsible-content">
        <button data-tab="Map" class="tab-btn-desktop active flex-1 p-3 text-sm font-semibold text-center text-gray-500 hover:bg-gray-200 transition-colors">Map</button>
        <button data-tab="Annotations" class="tab-btn-desktop flex-1 p-3 text-sm font-semibold text-center text-gray-500 hover:bg-gray-200 transition-colors">Annotation</button>
        <button data-tab="Story" class="tab-btn-desktop flex-1 p-3 text-sm font-semibold text-center text-gray-500 hover:bg-gray-200 transition-colors">Story</button>
        <button data-tab="Info" class="tab-btn-desktop flex-1 p-3 text-sm font-semibold text-center text-gray-500 hover:bg-gray-200 transition-colors">Info</button>
      </nav>

      <!-- Sidebar content -->
      <div class="flex-1 overflow-y-auto custom-scrollbar collapsible-content">
        <!-- Map panel -->
        <div id="panelMap" class="tab-panel p-4 space-y-5">
          <!-- Basemap selection -->
          <div class="space-y-2">
            <label for="basemap" class="text-sm font-medium text-gray-700">Basemap</label>
            <select id="basemap" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
              <option value="esri-imagery" selected>Esri World Imagery</option>
              <option value="g-streets">Google Streets</option>
              <option value="g-satellite">Google Satellite</option>
              <option value="hcmc-planning">HCMC Urban Planning</option>
            </select>
          </div>
          <!-- Historical map selection -->
          <div id="historicalMapModule" class="space-y-4 p-4 bg-gray-100 rounded-lg border border-gray-200">
            <h3 class="text-base font-semibold text-gray-800">Historical Map</h3>
            <div class="space-y-2">
              <label for="mapTypeFilter" class="text-sm font-medium text-gray-700">Map Type</label>
              <select id="mapTypeFilter" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                <option value="all" selected>All Types</option>
              </select>
            </div>
            <div class="space-y-2">
              <label for="allmapsId" class="text-sm font-medium text-gray-700">Choose Map</label>
              <select id="allmapsId" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></select>
            </div>
            <div class="space-y-2">
              <div class="flex items-center gap-2">
                <label for="customMapId" class="text-sm font-medium text-gray-700">or Custom Map ID</label>
                <a href="https://docs.google.com/document/d/1y-lMkiTF9v2gUij7zMp0nHOR2EfnUh3YQFdFN11JWPM/edit?usp=sharing" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-indigo-600" title="Learn more about Allmaps IDs">
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
                </a>
              </div>
              <div class="flex gap-2">
                <input type="text" id="customMapId" placeholder="Enter Allmaps ID, and Enter" class="flex-grow p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                <button id="loadCustomBtn" class="px-4 py-2 text-white bg-indigo-600 rounded-md hover:bg-indigo-700 font-semibold">Load</button>
              </div>
            </div>
          </div>
          <!-- View mode and opacity controls -->
          <div id="viewControls" class="space-y-4">
            <div class="space-y-2">
              <label class="text-sm font-medium text-gray-700">View Mode</label>
              <div id="viewModeButtons" class="grid grid-cols-2 md:grid-cols-4 gap-2">
                  <button data-mode="overlay" class="view-mode-btn active p-2 border border-gray-300 rounded-md flex flex-col items-center justify-center hover:bg-gray-100" title="Overlay">
                      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                      <span class="text-xs mt-1">Overlay</span>
                  </button>
                  <button data-mode="side-x" class="view-mode-btn p-2 border border-gray-300 rounded-md flex flex-col items-center justify-center hover:bg-gray-100" title="Side-by-side Vertical">
                      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16v12H4zM12 6v12"></path></svg>
                      <span class="text-xs mt-1">Side X</span>
                  </button>
                  <button data-mode="side-y" class="view-mode-btn p-2 border border-gray-300 rounded-md flex flex-col items-center justify-center hover:bg-gray-100" title="Side-by-side Horizontal">
                      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16v12H4zM4 12h16"></path></svg>
                      <span class="text-xs mt-1">Side Y</span>
                  </button>
                  <button data-mode="spy" class="view-mode-btn p-2 border border-gray-300 rounded-md flex flex-col items-center justify-center hover:bg-gray-100" title="Spyglass">
                      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                      <span class="text-xs mt-1">Spyglass</span>
                  </button>
              </div>
            </div>
            <div class="space-y-2">
              <label class="text-sm font-medium text-gray-700">Opacity</label>
              <div class="flex items-center gap-3">
                <input id="opacityRange" type="range" min="0" max="1" step="0.01" value="0.80" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                <span id="opLabel" class="text-sm font-mono text-gray-600 w-10 text-center">80%</span>
              </div>
            </div>
          </div>
          <!-- Map actions -->
          <div class="pt-4 border-t border-gray-200 flex gap-2">
            <button id="metaBtn" disabled class="flex-1 px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed font-semibold">
              Metadata
            </button>
            <button id="zoomToMapBtn" class="flex-1 px-4 py-2 text-white bg-indigo-600 rounded-md hover:bg-indigo-700 font-semibold disabled:opacity-50 disabled:cursor-not-allowed" title="Zoom to map extent" disabled>
              Zoom to Extent
            </button>
          </div>
          <!-- Loader and status message -->
          <div class="flex items-center justify-center gap-2 min-h-[20px]">
            <div id="loader" class="hidden h-5 w-5 animate-spin rounded-full border-2 border-solid border-indigo-600 border-r-transparent"></div>
            <div id="status" class="text-sm text-gray-500"></div>
          </div>
          <!-- Clear cache button -->
          <div class="pt-4 border-t border-gray-200">
            <button id="clearStateBtn" class="w-full px-4 py-2 text-sm font-semibold text-white bg-red-600 rounded-md hover:bg-red-700">Clear Cache & Reload</button>
            <p class="text-xs text-gray-500 mt-2">This will remove all saved annotations, story scenes, and view settings from your browser.</p>
          </div>
        </div>
        
        <!-- Annotations panel -->
        <div id="panelAnnotations" class="tab-panel hidden p-4 space-y-4">
          <!-- Search module -->
          <div id="searchModule" class="pb-4 border-b">
            <div class="flex gap-2 items-center">
              <input id="searchQuery" type="text" placeholder="Search for a place..." class="flex-grow p-2 border border-gray-300 rounded-md">
              <button id="searchClearBtn" title="Clear search" class="p-2 text-white bg-red-600 rounded-md hover:bg-red-700">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
              </button>
              <button id="searchLocate" title="Find my location" class="p-2 text-white bg-green-600 rounded-md hover:bg-green-700">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
              </button>
            </div>
            <div id="searchResults" class="mt-2 h-48 overflow-auto custom-scrollbar space-y-1">
            </div>
          </div>
          
          <!-- Annotation tools -->
          <div>
            <div id="drawTools" class="space-y-3 p-2 bg-gray-100 rounded-lg">
              <div class="flex gap-2 items-center">
                <span class="text-sm font-medium text-gray-700 w-14 text-right pr-2">Draw:</span>
                <div id="toolModeGroup" class="flex flex-1 select-none">
                  <button id="toolPointBtn" data-mode="point" class="seg-btn flex-1 px-2 py-1 text-xs font-medium bg-white border border-gray-300 rounded-l-md hover:bg-gray-100">Point</button>
                  <button id="toolLineBtn" data-mode="line" class="seg-btn flex-1 px-2 py-1 text-xs font-medium bg-white border-t border-b border-gray-300 hover:bg-gray-100">Line</button>
                  <button id="toolPolyBtn" data-mode="poly" class="seg-btn flex-1 px-2 py-1 text-xs font-medium bg-white border-t border-b border-gray-300 hover:bg-gray-100">Object</button>
                  <button id="toolEditBtn" data-mode="edit" class="seg-btn flex-1 px-2 py-1 text-xs font-medium bg-white border border-gray-300 rounded-r-md hover:bg-gray-100" title="Edit geometry (drag points/edges; Ctrl/⌘+Click deletes vertex)">Edit</button>
                </div>
              </div>
              <div id="annotationActions" class="flex gap-2 items-center flex-wrap">
                <input id="importCsvInput" type="file" accept=".csv,text/csv,.geojson,application/geo+json,application/json" class="hidden" />
                <button id="importCsvBtn" title="Load Annotations" class="flex-1 px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-100">Load</button>
                <button id="exportCsv" title="Export Annotations" class="flex-1 px-3 py-1.5 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 disabled:opacity-50" disabled>Export</button>
                <button id="researchClear" title="Clear All Annotations" class="flex-1 px-3 py-1.5 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">Clear All</button>
              </div>
            </div>
            <div class="mt-2 h-80 overflow-auto custom-scrollbar border border-gray-200 rounded-lg">
              <table id="annoTable" class="w-full text-sm text-left text-gray-600" style="table-layout: fixed;">
                <thead class="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0 z-10">
                  <tr>
                    <th scope="col" class="px-4 py-2">Label</th>
                    <th scope="col" class="px-4 py-2">Actions</th>
                  </tr>
                </thead>
                <tbody id="annoTbody" class="bg-white"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Story panel -->
        <div id="panelStory" class="tab-panel hidden p-4 space-y-4">
          <!-- Scene capture form -->
          <div id="story-capture-form" class="p-4 space-y-3 bg-gray-100 rounded-lg border border-gray-200">
            <input type="text" id="sceneTitleInput" placeholder="Scene Title" class="w-full p-2 border border-gray-300 rounded-md">
            <textarea id="sceneDetailsInput" placeholder="Scene Details..." rows="2" class="w-full p-2 border border-gray-300 rounded-md"></textarea>
            <div>
              <label for="sceneDelayInput" class="block text-sm font-medium text-gray-700 mb-1">Autoplay (seconds)</label>
              <input type="number" id="sceneDelayInput" value="2" min="1" max="60" class="w-full p-2 border border-gray-300 rounded-md">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Visible Annotations</label>
              <div id="sceneAnnotationList" class="h-32 overflow-y-auto custom-scrollbar border border-gray-300 rounded-md bg-white p-2 space-y-1">
                <p class="text-xs text-gray-500 p-2">No annotations available.</p>
              </div>
            </div>
            <div class="flex gap-2">
              <button id="captureSceneBtn" class="flex-1 px-4 py-2 text-white bg-indigo-600 rounded-md hover:bg-indigo-700 font-semibold">Capture Scene</button>
              <button id="cancelEditBtn" class="hidden px-4 py-2 text-white bg-red-600 rounded-md hover:bg-red-700 font-semibold">Cancel</button>
            </div>
          </div>
          <!-- Story actions -->
          <div id="storyActions" class="flex flex-wrap gap-2 justify-center p-2 rounded-lg">
            <input id="loadStoryInput" type="file" accept=".json,application/json" class="hidden" />
            <button id="loadStoryBtn" class="px-3 py-1.5 text-sm font-semibold text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-100">Load</button>
            <button id="downloadStoryBtn" class="px-3 py-1.5 text-sm font-semibold text-white bg-green-600 rounded-md hover:bg-green-700 disabled:opacity-50" disabled>Export</button>
            <button id="presentStoryBtn" class="px-3 py-1.5 text-sm font-semibold text-white bg-indigo-600 rounded-md hover:bg-indigo-700 disabled:opacity-50" disabled>Present</button>
          </div>
          <!-- Story list -->
           <div class="h-60 overflow-auto custom-scrollbar border border-gray-200 rounded-lg">
            <ul id="story-list" class="divide-y divide-gray-200">
              <li class="p-4 text-center text-gray-500" id="story-placeholder">No scenes captured yet.</li>
            </ul>
          </div>
        </div>

        <!-- Info panel -->
        <div id="panelInfo" class="tab-panel hidden p-4 space-y-4">
          <div class="grid grid-cols-1 gap-4">
            <div class="space-y-3 p-4 bg-white border border-gray-200 rounded-lg">
              <h3 class="text-sm font-semibold text-gray-800">Quick Start</h3>
              <button id="startTourBtn" class="w-full px-3 py-2 text-sm font-semibold text-white bg-indigo-600 rounded-md hover:bg-indigo-700">Take a Tour</button>
            </div>
            <div class="space-y-3 p-4 bg-white border border-gray-200 rounded-lg">
              <h3 class="text-sm font-semibold text-gray-800">Links</h3>
              <div class="flex flex-wrap gap-2">
                <a class="px-3 py-1.5 text-xs font-semibold text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-100" href="https://www.canva.com/design/DAGsdCxbAho/UqzPt9W5ceAJH7sPdhvYOg/view?utm_content=DAGsdCxbAho&utm_campaign=designshare&utm_medium=link2&utm_source=uniquelinks&utlId=h9602289aa0" target="_blank" rel="noreferrer">About Us</a>
                <a class="px-3 py-1.5 text-xs font-semibold text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-100" href="https://forms.gle/xJexnw5sDWxSETNt5" target="_blank" rel="noreferrer">Feedback</a>
                <a class="px-3 py-1.5 text-xs font-semibold text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-100" href="mailto:vietnam.ma.project@gmail.com" target="_blank" rel="noreferrer">Email Us</a>
              </div>
            </div>
            <div class="space-y-3 p-4 bg-white border border-gray-200 rounded-lg">
              <h3 class="text-sm font-semibold text-gray-800">Support Us</h3>
              <p class="text-xs text-gray-600">If you find this project useful, please consider supporting its development.</p>
              <button id="donateBtn" class="w-full px-3 py-2 text-sm font-semibold text-white bg-green-600 rounded-md hover:bg-green-700">Donate</button>
            </div>
          </div>
          <div class="p-4 bg-white border border-gray-200 rounded-lg">
            <details>
              <summary class="cursor-pointer text-sm font-semibold text-gray-800 select-none">Tips & Shortcuts</summary>
              <ul class="mt-2 list-disc list-inside space-y-1 text-xs text-gray-600">
                <li><b>Navigation:</b> Drag to pan, scroll to zoom, Ctrl/⌘+drag to rotate.</li>
                <li><b>Sidebar:</b> Use the arrow to collapse/expand for more map space.</li>
                <li><b>View Modes:</b> Side‑X/Side‑Y/Spyglass; drag handles to adjust.</li>
                <li><b>Annotations:</b> Draw Point/Line/Object; press Enter to finish, Esc to cancel.</li>
                <li><b>Stories:</b> Capture scenes, reorder, present or export.</li>
                <li><b>Data:</b> Load CSV/GeoJSON; Export GeoJSON (annotations); Story as JSON.</li>
                <li><b>Coordinates:</b> Right‑click the map; click value to copy.</li>
              </ul>
            </details>
          </div>
          <div class="text-center text-xs text-gray-400">Built with OpenLayers, Allmaps & OSM</div>
        </div>
      </div>
    </aside>
    <button id="sidebar-toggle" class="absolute z-20 top-1/2 -translate-y-1/2 w-8 h-16 bg-white hover:bg-gray-100 border-y border-r border-gray-300 rounded-r-full shadow-md flex items-center justify-center transition-all duration-300 ease-in-out">
      <svg id="sidebar-toggle-icon" class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path></svg>
    </button>

    <!-- Map container -->
    <main class="flex-1 relative bg-gray-300">
      <div id="map" class="h-full w-full"></div>
      <div id="dividerX" class="divider-v"></div>
      <div id="dividerY" class="divider-h"></div>
      <div id="lens" class="lens"></div>
      <div id="lensHandle" class="lens-handle" title="Resize lens"></div>
      <div id="dividerHandleX" class="handle handle-v" title="Drag split (X)"></div>
      <div id="dividerHandleY" class="handle handle-h" title="Drag split (Y)"></div>
    </main>
  </div>

  

  <!-- Coordinate menu -->
  <div id="coordMenu" class="hidden absolute z-50 min-w-[220px] bg-white border border-gray-300 rounded-lg shadow-xl p-3" role="dialog" aria-label="Coordinates">
    <div class="font-semibold text-sm text-gray-800 mb-2">Coordinates</div>
    <div id="coordValue" class="font-mono text-xs text-gray-800 bg-gray-100 border border-gray-200 rounded-md p-2 cursor-pointer select-all">—</div>
    <div class="text-xs text-gray-500 mt-2">Click the value to copy.</div>
    <div class="flex gap-2 mt-2">
        <button id="coordCopy" class="flex-1 px-3 py-1 text-xs font-semibold text-white bg-gray-800 rounded-md hover:bg-gray-900">Copy</button>
        <button id="coordClose" class="flex-1 px-3 py-1 text-xs font-semibold text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">Close</button>
    </div>
  </div>

  <!-- Popup -->
  <div id="popup" class="ol-popup relative z-[1050] bg-white rounded-lg shadow-lg border border-gray-300 min-w-[280px] max-w-[320px] pointer-events-auto">
    <a href="#" id="popup-closer" class="ol-popup-closer absolute top-1 right-2 text-xl text-gray-500 hover:text-gray-800">&times;</a>
    <div id="popup-content" class="p-3"></div>
  </div>
  
  <!-- Presentation overlay -->
  <div id="presentation-overlay" class="hidden fixed inset-0 bg-transparent z-40 flex-col text-white font-sans pointer-events-none">
    <div class="absolute bottom-5 left-5 right-5 max-w-2xl mx-auto flex flex-col gap-3">
      <div id="presentation-nav" class="flex flex-wrap gap-3 items-center self-end pointer-events-auto">
          <span id="presentation-counter" class="font-mono text-sm px-3 py-1.5 bg-gray-900/80 border border-white/10 rounded-md"></span>
          <button id="presentation-prev" class="px-4 py-1.5 text-sm font-semibold text-white bg-gray-900/80 border border-white/10 rounded-md hover:bg-white/10 disabled:opacity-50">&lt; Prev</button>
          <button id="presentation-next" class="px-4 py-1.5 text-sm font-semibold text-white bg-gray-900/80 border border-white/10 rounded-md hover:bg-white/10 disabled:opacity-50">Next &gt;</button>
          <button id="presentation-play-pause" class="p-1.5 text-white bg-gray-900/80 border border-white/10 rounded-md hover:bg-white/10 flex items-center justify-center" title="Play/Pause Autoplay">
            <svg id="play-icon" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"></path></svg>
            <svg id="pause-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M5.75 3a.75.75 0 00-.75.75v12.5c0 .414.336.75.75.75h1.5a.75.75 0 00.75-.75V3.75A.75.75 0 007.25 3h-1.5zM12.75 3a.75.75 0 00-.75.75v12.5c0 .414.336.75.75.75h1.5a.75.75 0 00.75-.75V3.75a.75.75 0 00-.75-.75h-1.5z"></path></svg>
          </button>
          <button id="presentation-exit" class="px-3 py-1.5 text-sm font-semibold text-white bg-gray-900/80 border border-white/10 rounded-md hover:bg-white/10">Exit</button>
      </div>
      <div id="presentation-content" class="w-full bg-gray-900/80 backdrop-blur-sm border border-white/10 rounded-lg p-5 pointer-events-auto">
          <h2 id="presentation-title" class="text-xl font-bold mb-2"></h2>
          <p id="presentation-details" class="text-sm max-h-24 overflow-y-auto"></p>
      </div>
    </div>
  </div>

  <!-- Guided Tour Overlay Elements -->
  <div id="tour-backdrop" class="tour-backdrop"></div>
  <div id="tour-highlight" class="tour-highlight"></div>
  <div id="tour-popover" class="tour-popover">
    <div class="tour-header" id="tour-title">Welcome</div>
    <div class="tour-body" id="tour-text">Let’s take a quick tour.</div>
    <div class="tour-footer">
      <span class="counter" id="tour-counter"></span>
      <div class="flex gap-2">
        <button id="tour-skip" class="btn btn-ghost">Skip</button>
        <button id="tour-prev" class="btn btn-ghost">Back</button>
        <button id="tour-next" class="btn btn-primary">Next</button>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div id="metaModal" class="hidden fixed inset-0 bg-gray-900/60 z-[1050] flex items-center justify-center" role="dialog" aria-modal="true" aria-labelledby="metaTitle">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-[90vw] max-h-[80vh] flex flex-col">
      <div class="flex items-center justify-between p-4 border-b">
        <h3 id="metaTitle" class="text-lg font-bold text-gray-800">Map Metadata</h3>
        <button id="closeMeta" class="text-2xl text-gray-500 hover:text-gray-800" aria-label="Close">×</button>
      </div>
      <div id="metaSummary" class="p-4 overflow-y-auto text-sm space-y-2">
        <div class="grid grid-cols-[max-content,1fr] gap-x-4 gap-y-2">
          </div>
      </div>
      <div class="p-4 border-t text-xs text-gray-600">Footprint source: <span id="metaLinkWrap" class="text-gray-400">–</span></div>
    </div>
  </div>

  <div id="donateModal" class="hidden fixed inset-0 bg-gray-900/60 z-[1050] flex items-center justify-center" role="dialog" aria-modal="true" aria-labelledby="donateTitle">
    <div class="bg-white rounded-lg shadow-xl max-w-xs w-[90vw] flex flex-col">
      <div class="flex items-center justify-between p-4 border-b">
        <h3 id="donateTitle" class="text-lg font-bold text-gray-800">Support the Project</h3>
        <button id="closeDonate" class="text-2xl text-gray-500 hover:text-gray-800" aria-label="Close">×</button>
      </div>
      <img src="https://raw.githubusercontent.com/lqtue/phuongnao/main/qr-code.jpg" alt="Donation QR Code" class="p-4">
    </div>
  </div>

  <div id="annoModal" class="hidden fixed inset-0 bg-gray-900/60 z-[1050] flex items-center justify-center" role="dialog" aria-modal="true" aria-labelledby="annoTitle">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-[90vw] max-h-[80vh] flex flex-col">
      <div class="flex items-center justify-between p-4 border-b">
        <h3 id="annoTitle" class="text-lg font-bold text-gray-800">Edit Annotation</h3>
        <button id="closeAnnoModal" class="text-2xl text-gray-500 hover:text-gray-800" aria-label="Close">×</button>
      </div>
      <div class="p-4 space-y-4 overflow-y-auto custom-scrollbar">
        <div>
          <label for="annoLabelInput" class="block text-sm font-medium text-gray-700 mb-1">Label</label>
          <input type="text" id="annoLabelInput" class="w-full p-2 border border-gray-300 rounded-md" placeholder="A short name for the feature">
        </div>
        <div>
          <label for="annoDetailsInput" class="block text-sm font-medium text-gray-700 mb-1">Details</label>
          <textarea id="annoDetailsInput" rows="3" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Add detailed notes here..."></textarea>
        </div>
        <div>
          <label for="annoColorInput" class="block text-sm font-medium text-gray-700 mb-1">Color</label>
          <input type="color" id="annoColorInput" class="w-full h-10 p-1 border border-gray-300 rounded-md" value="#2563eb">
        </div>
        <div class="pt-4 border-t space-y-2">
          <div>
            <label for="annoImg1Input" class="block text-sm font-medium text-gray-700 mb-1">Image URL</label>
            <input type="text" id="annoImg1Input" class="w-full p-2 border border-gray-300 rounded-md" placeholder="https://...">
          </div>
          <div id="annoImg2Container" class="hidden space-y-1">
            <label for="annoImg2Input" class="block text-sm font-medium text-gray-700">Second Image URL (for comparison)</label>
            <div class="flex gap-2">
              <input type="text" id="annoImg2Input" class="flex-grow p-2 border border-gray-300 rounded-md" placeholder="https://...">
              <button id="removeImg2Btn" type="button" class="p-2 text-white bg-red-600 rounded-md hover:bg-red-700" title="Remove second image"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
            </div>
          </div>
          <button id="addImg2Btn" type="button" class="w-full px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-dashed border-gray-400 rounded-md hover:bg-gray-100">
            + Add a second image for comparison
          </button>
        </div>
      </div>
      <div class="p-4 border-t bg-gray-50">
        <button id="saveAnnoBtn" class="w-full px-4 py-2 text-white bg-green-600 rounded-md hover:bg-green-700 font-semibold">Save Changes</button>
      </div>
    </div>
  </div>

  <script src="script.js"></script>
</body>
</html>
